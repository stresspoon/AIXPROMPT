<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AIXPROMPT Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#131313; --fg:#fff; --muted:#bcbcbc; --accent:#ff3d00; --card:#1b1b1b; --stroke:#2a2a2a; --radius:16px; --shadow:0 6px 24px rgba(0,0,0,.35); }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{ margin:0; background:var(--bg); color:var(--fg); font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; line-height:1.5 }
    .wrap{ max-width:840px; margin:0 auto; padding:28px 20px 80px }
    header{ display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:20px }
    .brand{ font-weight:800; letter-spacing:1px; font-size:20px; display:inline-flex; align-items:center; gap:10px }
    .brand .dot{ width:10px; height:10px; border-radius:50%; background:var(--accent); display:inline-block }
    .subtitle{ color:var(--muted); font-size:13px }
    .card{ background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow) }
    .row{ display:grid; grid-template-columns:120px 1fr; gap:12px; align-items:center; margin-bottom:12px }
    label{ color:#ddd; font-size:13px }
    input[type="text"], textarea{ width:100%; background:#111; color:#fff; border:1px solid var(--stroke); border-radius:12px; padding:10px; font-size:14px }
    textarea{ min-height:160px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; line-height:1.6 }
    input[type="file"]{ color:#ddd }
    .actions{ display:flex; gap:10px; margin-top:12px }
    button{ background:var(--accent); color:#fff; border:none; padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer; box-shadow:var(--shadow) }
    .secondary{ background:#2a2a2a; border:1px solid var(--stroke) }
    .note{ color:var(--muted); font-size:12px; margin-top:6px }
    .preview{ width:100%; border:1px dashed var(--stroke); border-radius:12px; overflow:hidden; display:grid; place-items:center; aspect-ratio:4/5; background:#0f0f0f }
    .preview img{ width:100%; height:100%; object-fit:cover }
    .danger{ color:#ff6b6b }
    .preview.drop{ border-color: var(--accent); box-shadow: 0 0 0 3px rgba(255,61,0,.25) inset }
    .ag-model{ display:flex; align-items:center; gap:8px; font-size:12px; color:var(--muted) }
    .ag-model .ag-current{ font-size:14px }
    .ag-model .ag-actions{ display:flex; gap:6px }
    .ag-model .ag-set{ background:#2a2a2a; color:#fff; border:1px solid var(--stroke); border-radius:8px; padding:6px 8px; cursor:pointer }
    /* ê´€ë¦¬ì ê°¤ëŸ¬ë¦¬ */
    .ag-grid{ display:grid; grid-template-columns:repeat(12,1fr); gap:18px; margin-top:16px }
    .ag-card{ grid-column: span 12; background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius); overflow:hidden; box-shadow:var(--shadow); display:grid; grid-template-columns:1fr }
    .ag-media{ position:relative; aspect-ratio: 4 / 5; background:#0f0f0f }
    .ag-media img{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover }
    .ag-badge{ position:absolute; left:14px; top:14px; padding:6px 10px; border-radius:999px; background:rgba(0,0,0,.55); color:#fff; font-size:12px; backdrop-filter: blur(4px); border:1px solid rgba(255,255,255,.12) }
    .ag-body{ padding:12px; display:flex; flex-direction:column; gap:8px }
    .ag-title{ font-size:14px; font-weight:700 }
    .ag-prompt{ color:var(--muted); font-size:12px; line-height:1.6; max-height:3.2em; overflow:hidden; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical }
    .ag-overlay{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; gap:8px; background:rgba(19,19,19,.5); color:#fff; opacity:0; transition:opacity .15s ease; user-select:none }
    .ag-media:hover .ag-overlay{ opacity:1 }
    .ag-tool{ pointer-events:auto; background:#2a2a2a; color:#fff; border:1px solid var(--stroke); border-radius:10px; padding:8px 10px; font-weight:800; cursor:pointer; box-shadow:var(--shadow) }
    .ag-tool.del{ background:#ff4d4d; border-color:#ff4d4d }
    .ag-tool[disabled]{ opacity:.6; cursor:progress }
    @media (min-width:760px){ .ag-card{ grid-column: span 6 } }
    @media (min-width:1080px){ .ag-card{ grid-column: span 4 } }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div class="brand"><span class="dot"></span> AIXPROMPT Admin</div>
        <div class="subtitle">ê´€ë¦¬ìë§Œ ì ‘ê·¼ â€¢ ë¡œì»¬ ì´ë¯¸ì§€ ì—…ë¡œë“œ â†’ GitHub ì»¤ë°‹</div>
      </div>
      <a href="./index.html" class="secondary" style="text-decoration:none; padding:10px 14px; border-radius:12px; border:1px solid var(--stroke); background:#2a2a2a; color:#fff">ì‚¬ìš©ì í˜ì´ì§€</a>
    </header>

    <div id="loginCard" class="card" style="margin-bottom:16px; display:none">
      <div class="row">
        <label>ì•„ì´ë””</label>
        <input id="uid" type="text" placeholder="admin" />
      </div>
      <div class="row">
        <label>ë¹„ë°€ë²ˆí˜¸</label>
        <input id="pwd" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" />
      </div>
      <div class="actions">
        <button id="loginBtn">ë¡œê·¸ì¸</button>
      </div>
      <div class="note">ì €ì¥ëœ ë¡œê·¸ì¸ì€ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ë§Œ ë³´ê´€ë©ë‹ˆë‹¤.</div>
    </div>

    <div id="formCard" class="card" style="display:none">
      <div class="row">
        <label>ì´ë¯¸ì§€ íŒŒì¼</label>
        <input id="file" type="file" accept="image/*" />
      </div>
      <div class="row">
        <label>ëª¨ë¸</label>
        <div style="display:flex; gap:8px">
          <label style="display:flex; align-items:center; gap:6px"><input type="radio" name="model" value="nanobanana" checked /> ğŸŒ Nanobanana</label>
          <label style="display:flex; align-items:center; gap:6px"><input type="radio" name="model" value="seedream4" /> ğŸ’™â­ Seedream 4.0</label>
        </div>
      </div>
      <div class="row">
        <label>í”„ë¡¬í”„íŠ¸</label>
        <textarea id="prompt" placeholder="í”„ë¡¬í”„íŠ¸ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”"></textarea>
      </div>
      <div class="row">
        <label>ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°</label>
        <div class="preview" id="preview"><span class="note">ì´ë¯¸ì§€ ì„ íƒ ì‹œ ë¯¸ë¦¬ë³´ê¸°</span></div>
      </div>
      <div class="actions">
        <button id="save">ì €ì¥(ì»¤ë°‹)</button>
        <button id="appendOnly" class="secondary">ì´ë¯¸ì§€ ì—†ì´ JSONë§Œ ì¶”ê°€</button>
        <button id="dangerClear" class="secondary danger" title="ì£¼ì˜: ì „ì²´ JSON ì´ˆê¸°í™”">ë°ì´í„° ì´ˆê¸°í™”</button>
        <button id="logout" class="secondary">ë¡œê·¸ì•„ì›ƒ</button>
        <button id="loadList" class="secondary">ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      </div>
    </div>

    <p class="note" style="margin-top:16px">ë¬´ë°±ì—”ë“œ êµ¬ì¡°: ì´ë¯¸ì§€ëŠ” `public/images/yyyymmdd-hhmmss-íŒŒì¼ëª…`ìœ¼ë¡œ ì €ì¥, `data/prompts.json`ì— í•­ëª© ì¶”ê°€ â†’ Vercel ì •ì  ë°°í¬</p>

    <div class="actions" style="margin-top:12px">
      <button id="loadGrid" class="secondary">ê°¤ëŸ¬ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸°/ìƒˆë¡œê³ ì¹¨</button>
    </div>
    <section id="adminGrid" class="ag-grid"></section>
  </div>

  <script>
    const $ = (s)=>document.querySelector(s);
    const loginCard = $('#loginCard');
    const formCard = $('#formCard');
    const file = $('#file');
    const promptEl = $('#prompt');
    const preview = $('#preview');
    const uid = $('#uid');
    const pwd = $('#pwd');
    function getModel(){ const el=document.querySelector('input[name="model"]:checked'); return el ? el.value : ''; }

    function getSelectedFile(){ return file && file.files && file.files[0]; }
    function setPreview(){
      preview.innerHTML = '';
      const imgf = getSelectedFile();
      if(!imgf){ preview.innerHTML = '<span class="note">ì´ë¯¸ì§€ ì„ íƒ ì‹œ ë¯¸ë¦¬ë³´ê¸°</span>'; return; }
      const img = document.createElement('img');
      img.src = URL.createObjectURL(imgf);
      preview.appendChild(img);
    }
    if(file){ file.addEventListener('change', setPreview); }

    // Drag & drop to preview
    function handleFiles(files){
      if(!files || !files.length) return;
      file.files = files; // set to input for consistency
      setPreview();
    }
    ['dragenter','dragover'].forEach(evt=> preview.addEventListener(evt, (e)=>{ e.preventDefault(); e.stopPropagation(); preview.classList.add('drop'); }));
    ;['dragleave','drop'].forEach(evt=> preview.addEventListener(evt, (e)=>{ e.preventDefault(); e.stopPropagation(); preview.classList.remove('drop'); }));
    preview.addEventListener('drop', (e)=>{
      const dt = e.dataTransfer; if(!dt) return;
      if(dt.files && dt.files.length){ handleFiles(dt.files); }
    });
    // Paste from clipboard
    document.addEventListener('paste', (e)=>{
      const items = e.clipboardData && e.clipboardData.items; if(!items) return;
      for(const it of items){
        if(it.kind === 'file'){
          const f = it.getAsFile();
          if(f && f.type.startsWith('image/')){
            const dt = new DataTransfer(); dt.items.add(f); handleFiles(dt.files); break;
          }
        }
      }
    });

    function getAuth(){
      return localStorage.getItem('AIX_AUTH') || '';
    }
    function setAuth(b64){
      localStorage.setItem('AIX_AUTH', b64);
    }
    function clearAuth(){
      localStorage.removeItem('AIX_AUTH');
    }

    async function checkAuth(){
      const token = getAuth();
      if(!token) return false;
      const r = await fetch('/api/auth-check', { headers: { 'Authorization': 'Basic '+token }});
      return r.ok;
    }

    async function ensureAuthUI(){
      const ok = await checkAuth();
      loginCard.style.display = ok ? 'none' : '';
      formCard.style.display = ok ? '' : 'none';
      if(!ok){ uid.value = ''; pwd.value=''; }
    }

    document.getElementById('loginBtn').addEventListener('click', async ()=>{
      const u = uid.value.trim(); const p = pwd.value.trim();
      if(!u || !p){ alert('ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }
      const b64 = btoa(u+':'+p);
      const r = await fetch('/api/auth-check', { headers:{ 'Authorization': 'Basic '+b64 }});
      if(r.ok){ setAuth(b64); await ensureAuthUI(); } else { alert('ë¡œê·¸ì¸ ì‹¤íŒ¨'); }
    });
    document.getElementById('logout').addEventListener('click', ()=>{ clearAuth(); ensureAuthUI(); });

    // Image compress helper to avoid 413 (payload too large)
    function fileToDataURL(file){
      return new Promise((resolve,reject)=>{ const fr=new FileReader(); fr.onload=()=>resolve(fr.result); fr.onerror=reject; fr.readAsDataURL(file); });
    }
    function dataURLToImage(dataURL){
      return new Promise((resolve,reject)=>{ const img=new Image(); img.onload=()=>resolve(img); img.onerror=reject; img.src=dataURL; });
    }
    function blobToBase64(blob){
      return new Promise((resolve,reject)=>{ const fr=new FileReader(); fr.onload=()=>{ const s=String(fr.result||''); const m=s.match(/^data:[^;]+;base64,(.*)$/); resolve(m?m[1]:s); }; fr.onerror=reject; fr.readAsDataURL(blob); });
    }
    async function compressImageFile(file, opts={ maxEdge: 1920, quality: 0.85, type: 'image/jpeg' }){
      const dataURL = await fileToDataURL(file);
      const img = await dataURLToImage(dataURL);
      const maxEdge = opts.maxEdge || 1920; const qualityBase = opts.quality || 0.85; const outType = opts.type || 'image/jpeg';
      let w = img.width, h = img.height; const ratio = Math.min(1, maxEdge / Math.max(w,h)); w = Math.round(w*ratio); h = Math.round(h*ratio);
      const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, w, h);
      let q = qualityBase; let blob = await new Promise(res=> canvas.toBlob(res, outType, q));
      // If still large, reduce quality progressively
      const MAX_BYTES = 4.2 * 1024 * 1024; // ~4.2MB to stay under Vercel limits
      while(blob && blob.size > MAX_BYTES && q > 0.5){ q -= 0.1; blob = await new Promise(res=> canvas.toBlob(res, outType, q)); }
      const base64 = await blobToBase64(blob);
      const name = (file.name || 'image').replace(/\.(png|jpg|jpeg|webp)$/i,'') + (outType==='image/jpeg'?'.jpg':outType==='image/webp'?'.webp':'.bin');
      return { base64, mime: outType, name };
    }

    async function saveItem(appendImage){
      if(!promptEl.value.trim()){ alert('í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
      const token = getAuth();
      if(!token){ alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; }
      let imageBase64 = null, imageName='', imageMime='application/octet-stream';
      const selected = getSelectedFile();
      if(appendImage && selected){
        try{
          const out = await compressImageFile(selected);
          imageBase64 = out.base64; imageName = out.name; imageMime = out.mime;
        }catch(err){
          // fallback: raw
          const buf = await selected.arrayBuffer(); let binary=''; const bytes=new Uint8Array(buf); for(let i=0;i<bytes.length;i++) binary+=String.fromCharCode(bytes[i]); imageBase64=btoa(binary); imageName=selected.name; imageMime=selected.type||'application/octet-stream';
        }
      }
      async function postOnce(b64, maxEdgeUsed){
        const r = await fetch('/api/append-card', { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization':'Basic '+token }, body: JSON.stringify({ prompt: promptEl.value.trim(), imageBase64: b64, imageName, imageMime, model: getModel() }) });
        return r;
      }
      let resp = await postOnce(imageBase64, 1920);
      if(resp && resp.status === 413 && appendImage && selected){
        // Re-compress smaller and retry once
        try{
          const smaller = await compressImageFile(selected, { maxEdge: 1280, quality: 0.75, type: 'image/jpeg' });
          imageBase64 = smaller.base64; imageName = smaller.name; imageMime = smaller.mime;
          resp = await postOnce(imageBase64, 1280);
        }catch(e){ /* ignore */ }
      }
      if(!resp.ok){ const t = await resp.text(); alert('ì €ì¥ ì‹¤íŒ¨: '+t); return; }
      alert('ì €ì¥ ì™„ë£Œ! ì ì‹œ í›„ ë°˜ì˜ë©ë‹ˆë‹¤.');
      promptEl.value=''; file.value=''; setPreview();
    }

    document.getElementById('save').addEventListener('click', ()=> saveItem(true));
    document.getElementById('appendOnly').addEventListener('click', ()=> saveItem(false));
    document.getElementById('dangerClear').addEventListener('click', async()=>{
      if(!confirm('ì •ë§ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ì–´ìš”? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
      const token = getAuth(); if(!token){ alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; }
      const resp = await fetch('/api/delete-card', { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization':'Basic '+token }, body: JSON.stringify({ reset: true }) });
      if(resp.ok){ alert('ì „ì²´ ì‚­ì œ ì™„ë£Œ'); } else { const t = await resp.text(); alert('ì‚­ì œ ì‹¤íŒ¨: '+t); }
    });

    const ADMIN_GRID = document.getElementById('adminGrid');
    function createAdminCard(item, index){
      const el = document.createElement('article');
      el.className = 'ag-card';
      el.innerHTML = `
        <div class="ag-media">
          <img src="${item.image}" alt="card ${index+1}" />
          <span class="ag-badge">#${index+1}</span>
          <div class="ag-overlay">
            <button class="ag-tool" data-model="nanobanana">ğŸŒ</button>
            <button class="ag-tool" data-model="seedream4">ğŸ’™</button>
            <button class="ag-tool del" data-action="delete">ì‚­ì œ</button>
          </div>
        </div>
        <div class="ag-body">
          ${item.title ? `<div class=\"ag-title\">${item.title}</div>` : ''}
          <div class="ag-prompt">${(item.prompt || '').replace(/</g,'&lt;').slice(0,140)}</div>
          
        </div>`;
      el.querySelector('[data-action="delete"]').addEventListener('click', async (ev)=>{
        ev.stopPropagation();
        const token = getAuth(); if(!token){ alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; }
        if(!confirm(`#${index+1} ì¹´ë“œë¥¼ ì‚­ì œí• ê¹Œìš”?`)) return;
        const resp = await fetch('/api/delete-card', { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization':'Basic '+token }, body: JSON.stringify({ index: index+1 }) });
        if(resp.ok){ loadGrid(); } else { const t = await resp.text(); alert('ì‚­ì œ ì‹¤íŒ¨: '+t); }
      });
      el.querySelectorAll('[data-model]').forEach(btn=>{
        btn.addEventListener('click', async (ev)=>{
          ev.stopPropagation();
          const token = getAuth(); if(!token){ alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; }
          const model = btn.getAttribute('data-model');
          btn.disabled = true;
          btn.textContent = 'ì €ì¥ì¤‘â€¦';
          try{
            const resp = await fetch('/api/update-card', { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization':'Basic '+token }, body: JSON.stringify({ index: index+1, model }) });
            if(resp.ok){
              // ì¦‰ì‹œ UI ë°˜ì˜
              const cur = el.querySelector('.ag-current'); if(cur){ cur.textContent = model === 'nanobanana' ? 'ğŸŒ' : 'ğŸ’™'; }
            }else{
              const t = await resp.text(); alert('ëª¨ë¸ ì„¤ì • ì‹¤íŒ¨: '+t);
            }
          } finally {
            btn.disabled = false; btn.textContent = btn.getAttribute('data-model') === 'nanobanana' ? 'ğŸŒ' : 'ğŸ’™';
          }
        });
      });
      return el;
    }
    async function loadGrid(){
      try{
        const res = await fetch('./data/prompts.json?nocache='+Date.now());
        if(!res.ok) throw new Error('load failed');
        const items = await res.json();
        ADMIN_GRID.innerHTML = '';
        items.forEach((it,i)=> ADMIN_GRID.appendChild(createAdminCard(it,i)));
      }catch(err){ ADMIN_GRID.innerHTML = '<div class="note">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>'; }
    }
    document.getElementById('loadGrid').addEventListener('click', ()=>{ loadGrid(); ADMIN_GRID.scrollIntoView({behavior:'smooth'}); });

    ensureAuthUI();
  </script>
</body>
</html>


